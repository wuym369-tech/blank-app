#目前是香調都進去五行也進去，現在要去新增調香比例要對
#現在新增比例對了
import streamlit as st
from datetime import date

# 1. 頁面配置
st.set_page_config(page_title="Aroma's Secret Lab", layout="centered")

# ==========================================
# 資料庫 A：78 種氣味清單與完整描述
# ==========================================
scent_map = {
    # --- 前調 (Top Notes) ---
    "前調 芳香 01": "富家千金 (小豆蔻/烏龍茶)",
    "前調 芳香 02": "夏天的風 (羅勒/百里香)",
    "前調 芳香 03": "野花 (小豆蔻/含羞草)",
    "前調 芳香 04": "肆意奔放 (小豆蔻/馬郁蘭)",
    "前調 芳香 05": "鄉愁 (梔子花/綠葉/甘草)",
    "前調 芳香 06": "茶樹 (茶樹)",
    "前調 芳香 07": "薄荷 (薄荷)",
    "前調 芳香 08": "馬鞭草 (馬鞭草)",
    "前調 芳香 09": "綠茶 (綠茶)",
    "前調 柑橘 01": "花園 (橘子/檸檬/開心果)",
    "前調 柑橘 02": "記憶蜜糖 (橘子/桃子)",
    "前調 柑橘 03": "寂靜秋夜 (胡蘿蔔/番茄/橙子)",
    "前調 柑橘 04": "氣泡水 (葡萄柚/橘子)",
    "前調 柑橘 05": "海邊漫步 (橙子/檸檬)",
    "前調 柑橘 06": "海灘 (佛手柑/檸檬/香橙)",
    "前調 柑橘 07": "純真 (橙子/茉莉/琥珀)",
    "前調 柑苔 01": "晨間森林 (無花果木/香根草)",
    "前調 柑苔 02": "信仰 (橘子/麝香/苦橙葉)",
    "前調 柑苔 03": "清新 (葡萄柚/橡木苔)",
    "前調 柑苔 04": "苔蘚 (苔蘚)",

    # --- 中調 (Middle Notes) ---
    "中調 果香 01": "夏日莊園 (柑橘/無花果)",
    "中調 果香 02": "純粹 (香瓜/橘子/黃瓜)",
    "中調 果香 03": "甜美 (草莓/梨/蜜橘)",
    "中調 果香 04": "情竇初開 (紅漿果/糖)",
    "中調 果香 05": "撒丁島 (橙花油/檸檬)",
    "中調 果香 06": "仲夏花園 (紅蘋果/玫瑰)",
    "中調 果香 07": "酸甜軟妹 (黑加侖/菠蘿/焦糖)",
    "中調 果香 08": "地中海 (香豌豆/檸檬/焦糖)",
    "中調 果香 09": "海邊微風 (黃葵/鹽)",
    "中調 果香 10": "咖啡廳 (甜蘋果/香橙花/香草)",
    "中調 果香 11": "柑橘 (柑橘)",
    "中調 果香 12": "檸檬 (檸檬)",
    "中調 果香 13": "百香果 (百香果)",
    "中調 果香 14": "青瓜 (青瓜)",
    "中調 果香 15": "青蘋果 (青蘋果)",
    "中調 花香 01": "白襯衫 (薰衣草/橙花)",
    "中調 花香 02": "優雅女人 (晚香玉/茉莉花)",
    "中調 花香 03": "雨後花園 (玫瑰/依蘭)",
    "中調 花香 04": "靜謐花園 (玫瑰/茉莉)",
    "中調 花香 05": "初春 (玫瑰/蜂蜜)",
    "中調 花香 06": "春意盎然 (茉莉/綠葉)",
    "中調 花香 07": "梨子酒 (梨/小蒼蘭)",
    "中調 花香 08": "森林小屋 (薰衣草/肉豆蔻)",
    "構調 花香 09": "稻香 (橙花/香草)",
    "中調 花香 10": "異域風情 (晚香玉/依蘭)",
    "中調 花香 11": "優雅 (茉莉/蘭花/李子)",
    "中調 花香 12": "薰衣草 (薰衣草)",
    "中調 花香 13": "夜來香 (夜來香)",
    "中調 花香 14": "梔子花 (梔子花)",
    "中調 花香 15": "依蘭 (依蘭)",
    "中調 花香 16": "玫瑰 (玫瑰)",
    "中調 花香 17": "風鈴草 (風鈴草)",
    "中調 花香 18": "茉莉 (茉莉)",
    "中調 花香 19": "桂花 (桂花)",

    # --- 後調 (Base Notes) ---
    "後調 東方 01": "雨落幽然 (苦橙/琥珀)",
    "後調 東方 02": "烏龍茶 (茶葉/香根草)",
    "後調 東方 03": "新倫敦男 (肉桂/煙草/橡木苔)",
    "後調 東方 04": "古老書店 (冬加豆)",
    "後調 東方 05": "西西里島 (杏仁/香草/麝香)",
    "後調 東方 06": "陽光 (紫羅蘭/香草/麝香)",
    "後調 東方 07": "高山微風 (迷迭香/廣藿香)",
    "後調 東方 08": "冬日壁爐 (琥珀/麝香)",
    "後調 東方 09": "荷爾蒙 (花椒/廣藿香)",
    "後調 東方 10": "法國紳士 (橘子/檀香木)",
    "後調 東方 11": "梅糖 (梨/杏仁/香草)",
    "後調 木質 01": "冬日松林 (雪松/麝香)",
    "後調 木質 02": "沉靜森林 (白松香/檀香)",
    "後調 木質 03": "沉穩 (莞荽/香根草/雪松木)",
    "後調 木質 04": "龍涎 (龍涎/琥珀/木質)",
    "後調 木質 05": "雪松 (雪松)",
    "後調 木質 06": "空靈 (麝香/沉香)",
    "後調 木質 07": "晨間山風 (香草/沉香)",
    "後調 木質 08": "寺廟 (黑胡椒/檀木)",
    "後調 木質 09": "雲霧 (迷迭香/樟木)",
    "後調 木質 10": "故鄉 (沉香/廣藿香)",
    "後調 木質 11": "焚香 (沉香/巴西紅木)",
    "後調 木質 12": "月光柏木 (苦橙/柏樹)",
    "後調 木質 13": "檀香 (檀香)"
}

scent_descriptions = {
    # --- 前調 (Top Notes) ---
    "前調 芳香 01": "清冷烏龍與辛香小豆蔻碰撞，彷彿在霧氣繚繞的清晨茶山中獨坐。",
    "前調 芳香 02": "清新的羅勒與百里香交織，如同漫步在灑滿午後陽光的歐式香草園。",
    "前調 芳香 03": "含羞草的粉感與小豆蔻的暖意，像是踏入一片開滿無名野花的靜謐荒野。",
    "前調 芳香 04": "馬郁蘭的藥草氣息帶動感性，散發出一種無拘無束、肆意奔放的自由感。",
    "前調 芳香 05": "梔子花的潔白與綠葉的清苦，勾起記憶中那抹淡淡的、帶有草木香的鄉愁。",
    "前調 芳香 06": "強勁的茶樹氣息，像是雨後森林般清冽，帶給靈魂最徹底的淨化與甦醒。",
    "前調 芳香 07": "極致清涼的薄荷，瞬間點燃感官，彷彿在炎熱夏日喝下一口冰鎮泉水。",
    "前調 芳香 08": "馬鞭草的檸檬清香，帶來輕盈跳躍的活力，讓心情隨之飛揚。",
    "前調 芳香 09": "優雅的綠茶清芬，如同細雨過後的竹林，安靜、內斂且充滿禪意。",
    "前調 柑橘 01": "橘子與檸檬的酸甜，伴隨開心果的微香，像是一場色彩繽紛的花園派對。",
    "前調 柑橘 02": "多汁的桃子融入柑橘，營造出被蜜糖包裹的童年記憶，甜而不膩。",
    "前調 柑橘 03": "胡蘿蔔與橙子的奇妙結合，如同在秋日的寂靜黃昏，看落葉鋪滿大地。",
    "前調 柑橘 04": "清爽噴湧的葡萄柚氣泡，充滿爆發力的酸甜，瞬間提振精神。",
    "前調 柑橘 05": "沁人心脾的清爽柑橘，彷彿光著腳在海邊漫步，感受浪花輕拍腳踝。",
    "前調 柑橘 06": "佛手柑的輕盈與檸檬的海風感，讓思緒飄向遙遠的地中海沙灘。",
    "前調 柑橘 07": "橘子與純真茉莉的邂逅，像是微風中搖曳的白色裙擺，純淨且動人。",
    "前調 柑苔 01": "無花果木與香根草的結合，如同清晨走進原始森林，腳下是潮濕的泥土。",
    "前調 柑苔 02": "苦橙葉與麝香的深層共鳴，代表一種內在的堅定，如同朝聖者的信仰。",
    "前調 柑苔 03": "橡木苔與葡萄柚的冷靜感，像是一陣穿透迷霧的清香，帶來極致的清醒。",
    "前調 柑苔 04": "潮濕的苔蘚氣息，帶有一絲泥土的芬芳，讓人不自覺地向大自然深處探索。",

    # --- 中調 (Middle Notes) ---
    "中調 果香 01": "柑橘與無花果的暖甜，彷彿置身於南法莊園，享受悠閒的午後時光。",
    "中調 果香 02": "甜美的香瓜與清涼黃瓜，純粹得不帶一絲雜質，讓感官瞬間降溫。",
    "中調 果香 03": "草莓與蜜橘的香甜，像是初戀時咬下的第一口水果糖，滿口芳甜。",
    "中調 果香 04": "紅漿果的酸甜與糖分的結合，譜寫出一曲關於情竇初開的甜蜜樂章。",
    "中調 果香 05": "橙花油與檸檬的清冽，帶您飛向撒丁島，感受海風中的清爽果味。",
    "中調 果香 06": "紅蘋果與玫瑰的交融，如同在仲夏的花園中，邂逅最燦爛的盛放。",
    "中調 果香 07": "黑加侖與菠蘿的奔放，帶有一點焦糖的甜潤，展現出酸甜軟妹的俏皮感。",
    "中調 果香 08": "香豌豆與焦糖的層次感，像是地中海陽光下的午後茶點，慵懶而滿足。",
    "中調 果香 09": "黃葵與鹽的結合，如同海邊拂過的微風，帶有一絲不露痕跡的迷人魅力。",
    "中調 果香 10": "香橙花與香草交織出的溫暖甜香，彷彿冬日午後，坐在瀰漫香氣的咖啡廳。",
    "中調 花香 01": "薰衣草與橙花的潔淨，像是一件剛在陽光下晾乾的白襯衫，讓人倍感舒心。",
    "中調 花香 02": "晚香玉與茉莉的濃郁花香，自信而優雅，綻放出成熟女性的迷人光彩。",
    "中調 花香 03": "玫瑰與依蘭在雨後濕潤的氣息中綻放，如同走入一座神祕且幽靜的庭園。",
    "中調 花香 04": "玫瑰與茉莉的經典結合，安靜地盛開在心田，營造出一份內心的靜謐。",
    "中調 花香 05": "蜂蜜包裹著初春的玫瑰，柔情似水，緩緩釋放出春天最溫柔的訊息。",
    "中調 花香 06": "茉莉與翠綠葉片的氣息，生機盎然，彷彿看見春芽在枝頭輕輕顫動。",
    "中調 花香 07": "梨與小蒼蘭交織出的微醺氣息，像是倒出一杯清透的梨子酒，晶瑩動人。",
    "中調 花香 08": "薰衣草與肉豆蔻的溫暖辛香，如同躲進大雪中的森林小屋，爐火正旺。",
    "中調 花香 09": "橙花與香草的清甜，帶有一絲稻米的溫潤感，是豐收季節最安心的問候。",
    "中調 花香 10": "依蘭與晚香玉的異國風情，神祕且大膽，領您踏上一場華麗的冒險之旅。",
    "中調 花香 11": "蘭花與李子的交織，優雅而不失靈動，在舉手投足間流露出高級質感。",
    "中調 花香 19": "清甜入骨的桂花香，彷彿在某個秋夜的街角，偶遇了一場關於月光的夢。",

    # --- 後調 (Base Notes) ---
    "後調 東方 01": "苦橙與琥珀的碰撞，如同細雨落下後的幽然森林，帶著神祕的暖意。",
    "後調 東方 02": "茶葉與香根草的交融，帶有一種沉澱過後的文雅，是靈魂深處的冷靜。",
    "後調 東方 03": "肉桂與煙草的成熟韻味，如同在倫敦街頭漫步的高雅男士，從容且自信。",
    "後調 東方 04": "冬加豆的醇厚氣息，像是走進一間塞滿舊書的老書店，時間在此凝固。",
    "後調 東方 05": "杏仁、香草與麝香的包裹，如同西西里島的暖陽，溫潤而令人陶醉。",
    "後調 東方 06": "紫羅蘭與香草的輕柔呼吸，像是在陽光下舒展身體，感受生命最柔軟的時刻。",
    "後調 東方 07": "迷迭香與廣藿香的交纏，如高山頂峰掠過的疾風，清澈且具有穿透力。",
    "後調 東方 08": "琥珀與麝香營造出爐火般的溫度，如同在寒冬中，靠近最溫暖的壁爐。",
    "後調 東方 09": "花椒的微辛與廣藿香的深沉，釋放出強烈的荷爾蒙感，危險且誘人。",
    "後調 東方 10": "橘子與檀香木的優雅結合，是一位風度翩翩的法國紳士，低調且尊貴。",
    "後調 東方 11": "梨與香草的甜糯感，像是童年最愛的那顆梅糖，在舌尖緩緩化開。",
    "後調 木質 01": "雪松與麝香的冷暖對比，如同銀裝素裹的松林，清冷而又透著生機。",
    "後調 木質 02": "白松香與檀香的沈靜，如同進入一片無人打擾的森林深處，呼吸著自由。",
    "後調 木質 03": "香根草與雪松的紮實感，賦予心靈一種無與倫比的沉穩與定力。",
    "後調 木質 04": "龍涎與琥珀的交織，如同時間雕琢而成的樹脂，閃爍著大地的光輝。",
    "後調 木質 05": "純粹的雪松香氣，潔淨且筆直，是靈魂最不容妥協的底色。",
    "後調 木質 06": "麝香與沉香的空靈結合，彷彿跨越時空的呼吸，縹緲且神聖。",
    "後調 木質 07": "香草與沉香的甜苦交織，如同晨間穿透山風的第一縷陽光，充滿希望。",
    "後調 木質 08": "檀木與黑胡椒的莊嚴感，像是踏入靜謐的寺廟，浮躁瞬間消散無蹤。",
    "後調 木質 09": "迷迭香與樟木的清冽，如雲霧繚繞的山巔，清冷且讓人心曠神怡。",
    "後調 木質 10": "沉香與廣藿香的厚重感，是記憶中無法抹去的故鄉記憶，深情且踏實。",
    "後調 木質 11": "沉香與巴西紅木的激盪，在焚香的縈繞中，展現出一種超脫塵世的靜謐。",
    "後調 木質 12": "柏樹與苦橙的堅韌，如同在月光下挺拔的柏樹，守護著夜晚的安寧。",
    "後調 木質 13": "純淨的檀香，溫潤如玉，是時間沉澱下來的最溫柔的底氣。"
}

# ==========================================
# # 資料庫 B：星座與心理特徵描述
# ==========================================
zodiac_db = {
    "白羊座": "天生的開拓者，充滿勇氣與活力。", "金牛座": "感官美好的守護者，追求質感生活。",
    "雙子座": "靈動的思想傳播者，充滿好奇心。", "巨蟹座": "細膩的療癒者，重視歸屬與情感。",
    "獅子座": "自信的領導者，散發強大創造力。", "處女座": "追求完美的工匠，擁有極致觀察力。",
    "天秤座": "和諧的協調者，追求優雅與平衡。", "天蠍座": "深邃的洞察者，意志強大且神祕。",
    "射手座": "真理的追求者，熱愛自由與冒險。", "摩羯座": "踏實的攀登者，擁有耐心與責任。",
    "水瓶座": "獨立的革新者，思維超前且獨特。", "雙魚座": "靈性的藝術家，靈魂充滿共情能力。"
}

personality_traits = {
    "芳香": "展現冷靜知性，適合追求邏輯與秩序的你。",
    "柑橘": "象徵親和活力，詮釋你開朗具感染力的性格。",
    "柑苔": "代表獨立探求，符合你追求獨特的自由靈魂。",
    "果香": "充滿生活情趣，對應你熱情且好奇的特質。",
    "花香": "展現優雅感性，呼應你細膩且富共情的內在。",
    "東方": "散發神祕權威，適合意志強大且深邃的你。",
    "木質": "象徵務實穩定，展現值得信賴的執行者風範。"
}
# --- [新增] 生肖資料庫 ---
zodiac_animal_db = {
    "鼠": "機敏靈活，觀察力極強，具備開拓精神。", "牛": "勤奮踏實，意志堅定，值得信賴。",
    "虎": "勇猛果敢，具備領袖氣質與冒險精神。", "兔": "溫柔文雅，心思細膩，追求和諧生活。",
    "龍": "充滿活力，志向遠大，具備天生的影響力。", "蛇": "冷靜神祕，直覺敏銳，處事精明幹練。",
    "馬": "熱情奔放，嚮往自由，行動力與生命力十足。", "羊": "仁慈體貼，富有藝術氣息與同情心。",
    "猴": "聰明伶俐，應變力強，充滿創意與好奇心。", "雞": "勤奮負責，講求效率，擁有獨到的審美。",
    "狗": "忠誠可靠，正義感強，是值得交心的夥伴。", "豬": "真誠厚道，性情豁達，天生自帶福氣。"
}
# --- [新增] 生肖五行對應表 ---
zodiac_elements = {
    "鼠": "水", "豬": "水",
    "虎": "木", "兔": "木",
    "蛇": "火", "馬": "火",
    "猴": "金", "雞": "金",
    "牛": "土", "龍": "土", "羊": "土", "狗": "土"
}

element_traits = {
    "水": "代表靈性與智慧，流動且具備極強的適應力。",
    "木": "代表成長與生機，充滿仁慈之心與向上攀升的能量。",
    "火": "代表熱情與禮儀，散發著溫暖與照亮他人的光芒。",
    "金": "代表剛毅與果斷，擁有高尚的節操與精準的決策力。",
    "土": "代表厚重與信用，象徵著值得信賴的包容力與穩定感。"
}
# --- [強化] 生命靈數資料庫 ---
life_num_detail = {
    "1": "開創數：象徵獨立、自信與天生的領導力。", "2": "合作數：象徵和諧、體貼與優異的協調性。",
    "3": "創意數：象徵熱情、表達與無窮的想像力。", "4": "執行數：象徵穩定、秩序與紮實的實踐力。",
    "5": "冒險數：象徵自由、多變與勇於挑戰的靈魂。", "6": "奉獻數：象徵責任、愛心與對美好的執著。",
    "7": "探求數：象徵智慧、內省與對真理的追求。", "8": "權威數：象徵豐盛、決策與強大的掌控力。",
    "9": "博愛數：象徵慈悲、理想與跨越邊界的視野。"
}
# 專業調香配比邏輯
perfume_logic = {
    "日常通勤": {"type": "EDT (淡香水)", "total_oil": 1.0, "ratios": [0.3, 0.4, 0.3], "desc": "3:4:3 黃金比例，確保層次平穩過渡。"},
    "約會派對": {"type": "EDP (淡香精)", "total_oil": 1.5, "ratios": [0.2, 0.3, 0.5], "desc": "強化後調比重，營造迷人長效氣場。"},
    "商務正式": {"type": "EDP (淡香精)", "total_oil": 1.2, "ratios": [0.2, 0.5, 0.3], "desc": "著重中調心臟，展現穩重且具信賴感的氣息。"},
    "運動休閒": {"type": "Cologne (古龍水)", "total_oil": 0.8, "ratios": [0.5, 0.3, 0.2], "desc": "高比例前調，釋放清爽爆發力。"},
    "冥想睡眠": {"type": "Mist (香氛噴霧)", "total_oil": 0.6, "ratios": [0.1, 0.6, 0.3], "desc": "療癒中調為主，營造安全包裹感。"}
}

# ==========================================
# 資料庫 C：16 型人格建議 (每項 3 個香味)
# ==========================================
mbti_db = {
    "INTJ (建築師)": {
        "title": "理性的戰略家",
        "top": ["前調 芳香 01", "前調 柑苔 01", "前調 芳香 05"],
        "mid": ["中調 花香 08", "中調 果香 09", "中調 花香 01"],
        "base": ["後調 木質 10", "後調 東方 02", "後調 木質 08"],
        "logic": "清冷茶香與沈穩木質，為深謀慮的思維提供留白空間。"
    },
    "INFP (調解者)": {
        "title": "溫柔理想主義者",
        "top": ["前調 柑橘 06", "前調 芳香 03", "前調 芳香 02"],
        "mid": ["中調 花香 03", "中調 花香 04", "中調 花香 19"],
        "base": ["後調 東方 05", "後調 木質 01", "後調 木質 02"],
        "logic": "柔軟的花香與包裹感強的後調，守護內心最純粹的理想。"
    },
    "INFJ (提倡者)": {
        "title": "寧靜的預言家",
        "top": ["前調 芳香 09", "前調 柑苔 04", "前調 芳香 05"],
        "mid": ["中調 花香 02", "中調 花香 06", "中調 花香 14"],
        "base": ["後調 木質 11", "後調 東方 04", "後調 木質 07"],
        "logic": "幽靜的綠茶與焚香，體現出深邃且具備靈性的洞察力。"
    },
    "ENFP (競選者)": {
        "title": "熱情的創意家",
        "top": ["前調 柑橘 04", "前調 柑橘 02", "前調 果香 03"],
        "mid": ["中調 果香 04", "中調 花香 07", "中調 果香 06"],
        "base": ["後調 東方 06", "後調 東方 11", "後調 木質 13"],
        "logic": "明亮跳躍的氣泡感與甜美果香，展現無窮的感染力。"
    },
    "ISTJ (物流師)": {
        "title": "務實的守護者",
        "top": ["前調 芳香 06", "前調 柑苔 02", "前調 芳香 08"],
        "mid": ["中調 花香 01", "中調 花香 08", "中調 果香 12"],
        "base": ["後調 木質 05", "後調 木質 03", "後調 木質 10"],
        "logic": "潔淨的草本與紮實的雪松，呼應嚴謹且可靠的職業風範。"
    },
    "ISFJ (守衛者)": {
        "title": "細膩的照顧者",
        "top": ["前調 柑橘 07", "前調 芳香 02", "前調 柑橘 01"],
        "mid": ["中調 花香 09", "中調 花香 12", "中調 花香 18"],
        "base": ["後調 木質 02", "後調 東方 08", "後調 木質 01"],
        "logic": "溫潤的花香與暖感木質，營造出如家一般安心的避風港。"
    },
    "ENTJ (指揮官)": {
        "title": "果斷的領導者",
        "top": ["前調 芳香 04", "前調 柑苔 01", "前調 柑橘 03"],
        "mid": ["中調 果香 05", "中調 花香 11", "中調 果香 01"],
        "base": ["後調 東方 09", "後調 木質 08", "後調 東方 10"],
        "logic": "強烈的辛香與廣藿香，奠定不容置疑的權威與執行氣場。"
    },
    "ENTP (辯論家)": {
        "title": "靈動的創新者",
        "top": ["前調 柑橘 04", "前調 芳香 07", "前調 柑苔 03"],
        "mid": ["中調 果香 08", "中調 果香 07", "中調 花香 17"],
        "base": ["後調 東方 03", "後調 東方 09", "後調 木質 11"],
        "logic": "充滿層次與反轉的冷熱調性，呼應其敏捷且具挑戰性的思維。"
    },
    "ENFJ (主人公)": {
        "title": "具感染力的領袖",
        "top": ["前調 柑橘 07", "前調 芳香 09", "前調 柑橘 05"],
        "mid": ["中調 花香 05", "中調 花香 09", "中調 果香 06"],
        "base": ["後調 木質 13", "後調 東方 08", "後調 木質 12"],
        "logic": "明亮陽光的花香調，傳遞溫暖且積極正向的領袖能量。"
    },
    "ESTJ (總經理)": {
        "title": "卓越的管理者",
        "top": ["前調 芳香 02", "前調 柑橘 05", "前調 芳香 08"],
        "mid": ["中調 花香 01", "中調 果香 11", "中調 果香 12"],
        "base": ["後調 木質 03", "後調 木質 08", "後調 木質 10"],
        "logic": "俐落的柑橘與沈穩檀木，體現高效能與秩序感。"
    },
    "ESFJ (執政官)": {
        "title": "熱心的社交家",
        "top": ["前調 果香 03", "前調 柑橘 02", "前調 柑橘 01"],
        "mid": ["中調 花香 14", "中調 花香 16", "中調 果香 10"],
        "base": ["後調 東方 06", "後調 木質 13", "後調 東方 11"],
        "logic": "親切甜美的花果香，讓社交場合充滿溫馨與和諧感。"
    },
    "ISTP (鑑賞家)": {
        "title": "冷靜的行動派",
        "top": ["前調 芳香 07", "前調 柑苔 03", "前調 芳香 06"],
        "mid": ["中調 果香 09", "中調 花香 08", "中調 果香 14"],
        "base": ["後調 木質 06", "後調 木質 12", "後調 東方 02"],
        "logic": "冷冽的薄荷與空靈的沉香，體現極簡且獨立的風格。"
    },
    "ISFP (探險家)": {
        "title": "感性的藝術家",
        "top": ["前調 柑橘 03", "前調 芳香 03", "前調 柑橘 06"],
        "mid": ["中調 花香 07", "中調 果香 02", "中調 花香 03"],
        "base": ["後調 木質 07", "後調 東方 05", "後調 木質 04"],
        "logic": "流動的自然氣息與感性木質，共鳴藝術性的感官體驗。"
    },
    "ESTP (企業家)": {
        "title": "大膽的開拓者",
        "top": ["前調 柑橘 04", "前調 柑苔 01", "前調 芳香 04"],
        "mid": ["中調 果香 07", "中調 果香 08", "中調 果香 13"],
        "base": ["後調 東方 07", "後調 東方 09", "後調 木質 12"],
        "logic": "能量爆發的柑橘與具有侵略性的東方調，展現冒險精神。"
    },
    "ESFP (表演者)": {
        "title": "閃耀的社交星",
        "top": ["前調 柑橘 02", "前調 柑橘 04", "前調 果香 04"],
        "mid": ["中調 花香 10", "中調 花香 13", "中調 果香 15"],
        "base": ["後調 東方 11", "後調 東方 06", "後調 東方 01"],
        "logic": "華麗奪目的花果香，讓每個瞬間都像是在舞台中央。"
    },
    "INTP (邏輯學家)": {
        "title": "冷靜的思考者",
        "top": ["前調 芳香 01", "前調 芳香 09", "前調 柑苔 04"],
        "mid": ["中調 果香 14", "中調 花香 06", "中調 果香 09"],
        "base": ["後調 木質 06", "後調 木質 11", "後調 東方 02"],
        "logic": "低調且神祕的沉香與茶香，支撐起無邊無際的思考海洋。"
    }
}


# ==========================================
# 工具函數
# ==========================================
def translate_scents(code_list):
    html_snippets = []
    for i, code in enumerate(code_list):
        full_info = scent_map.get(code, f"{code} (專屬配方)")
        name = full_info.split(" (")[0] if " (" in full_info else full_info
        ing = "(" + full_info.split(" (")[1] if " (" in full_info else ""
        desc = scent_descriptions.get(code, "這款香氣能優雅平衡你的內在能量。")
        
        snippet = f"""
        <div style='margin-bottom:8px; padding:10px; border-radius:10px; background:rgba(255,255,255,0.45); border:0.5px solid #eee;'>
            <div style='color: #8B4513; font-weight: bold; font-size: 14px;'>選項 {i+1}: {name}</div>
            <div style='font-size: 11px; color: #666;'>{ing}</div>
            <div style='font-size: 10px; color: #9E7E6B; margin-top:4px;'><i>{desc}</i></div>
        </div>
        """
        html_snippets.append(snippet)
    return "".join(html_snippets)

def get_life_num(bday):
    d = "".join(filter(str.isdigit, str(bday)))
    while len(d) > 1: d = str(sum(int(x) for x in d))
    return d

def get_zodiac(m, d):
    signs = [(1,20,"摩羯座"),(2,19,"水瓶座"),(3,21,"雙魚座"),(4,20,"白羊座"),(5,21,"金牛座"),(6,22,"雙子座"),(7,23,"巨蟹座"),(8,23,"獅子座"),(9,23,"處女座"),(10,24,"天秤座"),(11,23,"天蠍座"),(12,22,"射手座"),(12,31,"摩羯座")]
    for mm, dd, s in signs:
        if m < mm or (m == mm and d <= dd): return s
    return "摩羯座"

def get_chinese_zodiac(year):
    animals = ["猴", "雞", "狗", "豬", "鼠", "牛", "虎", "兔", "龍", "蛇", "馬", "羊"]
    return animals[year % 12]

# ==========================================
# 介面顯示區
# ==========================================
st.title("🧪 Aroma's Secret Lab")

c1, c2 = st.columns(2)
with c1:
    birthday = st.date_input("📅 出生年月日", value=date(2000, 1, 1))
    occasion = st.selectbox("🏙️ 使用場合", list(perfume_logic.keys()))
with c2:
    mbti_choice = st.selectbox("🧠 MBTI 人格", list(mbti_db.keys()))

if st.button("🔮 啟動 AI 深度分析"):
    # 命理與性格運算
    l_num = get_life_num(birthday)
    z_name = get_zodiac(birthday.month, birthday.day)
    c_zodiac = get_chinese_zodiac(birthday.year)
    c_element = zodiac_elements[c_zodiac]
    
    # 抓取資料庫資料
    res = mbti_db[mbti_choice]
    occ_data = perfume_logic[occasion]
    
    # 配比運算
    r = occ_data["ratios"]         
    total = occ_data["total_oil"]  
    top_ml, mid_ml, base_ml = round(total*r[0], 2), round(total*r[1], 2), round(total*r[2], 2)
    df = 25 # 滴數換算
    
    st.balloons()

    # --- 顯示診斷處方卡片 ---
    card_html = f"""
    <div style="background: white; padding: 25px; border-radius: 20px; border: 2px solid #1a1a1a; box-shadow: 8px 8px 0px #F5F5F5; color: #333;">
        <h2 style="margin:0; color: #8B4513; text-align:center;">🧬 AI 全維度調香處方</h2>
        
        <div style="display: flex; justify-content: center; gap: 8px; margin: 15px 0;">
            <span style="background: #E8F0FE; padding: 4px 10px; border-radius: 12px; font-size: 11px;"><b>🌠 星座：</b>{z_name}</span>
            <span style="background: #FFF0F0; padding: 4px 10px; border-radius: 12px; font-size: 11px;"><b>🏮 生肖：</b>{c_zodiac}({c_element})</span>
            <span style="background: #F0FDF4; padding: 4px 10px; border-radius: 12px; font-size: 11px;"><b>🔢 靈數：</b>{l_num}號人</span>
        </div>

        <div style="font-size: 12px; color: #666; line-height: 1.6; background: #FAFAFA; padding: 12px; border-radius: 10px; margin-bottom: 20px;">
            • <b>性格本質：</b>{zodiac_db[z_name]} & {zodiac_animal_db[c_zodiac]}<br>
            • <b>能量屬性：</b>五行屬【{c_element}】，代表 {element_traits[c_element]}<br>
            • <b>人生課題：</b>{life_num_detail[l_num]}
        </div>

        <div style="background: #FFF9F0; padding: 12px; border-radius: 10px; border-left: 5px solid #D4AF37;">
            <p style="font-size: 13px; font-weight: bold; margin:0;">【前調建議】(三選一)</p>
            {translate_scents(res['top'])}
        </div>
        <div style="background: #FFF9F0; padding: 12px; border-radius: 10px; border-left: 5px solid #D4AF37; margin-top:10px;">
            <p style="font-size: 13px; font-weight: bold; margin:0;">【中調建議】(三選一)</p>
            {translate_scents(res['mid'])}
        </div>
        <div style="background: #FFF9F0; padding: 12px; border-radius: 10px; border-left: 5px solid #D4AF37; margin-top:10px;">
            <p style="font-size: 13px; font-weight: bold; margin:0;">【後調建議】(三選一)</p>
            {translate_scents(res['base'])}
        </div>
        
        <p style="font-size: 11px; font-style: italic; color: #888; border-top: 1px dashed #ddd; padding-top: 10px; margin-top: 15px;">
            <b>💡 AI 調香邏輯：</b>{res['logic']}
        </p>
    </div>
    """.replace("\n", "")

    st.markdown(card_html, unsafe_allow_html=True)

    # --- 專業調配建議區 ---
    st.write("---")
    st.subheader("🧪 專業調配實驗室 (10ml 基準)")
    st.info(f"💡 **調香師筆記：** {occ_data['desc']}")
    
    col1, col2, col3 = st.columns(3)
    with col1:
        st.metric("前調建議量", f"{top_ml} ml", f"{round(top_ml * df)} 滴")
    with col2:
        st.metric("中調建議量", f"{mid_ml} ml", f"{round(mid_ml * df)} 滴")
    with col3:
        st.metric("後調建議量", f"{base_ml} ml", f"{round(base_ml * df)} 滴")
    
    st.warning("🧴 **小叮嚀：** 將上述滴數加入後，請用 95% 香水酒精補足至 10ml 刻度即可。")
